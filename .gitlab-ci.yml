---
stages:
  - molecule
  - changes
  - push

variables:
  GITHUB_USER: lotusnoir
  ANSIBLE_REMOTE_TMP: /tmp
  PY_COLORS: 1

######################################################
# DEFINE CHANGES RULES
######################################################
.molecule_rules:
  rules:
    - changes:
        - "defaults/**"
        - "files/**"
        - "handlers/**"
        - "meta/**"
        - "molecule/**"
        - "tasks/**"
        - "templates/**"
        - "vars/**"
        - "!**/.ansible-lint"
        - "!**/CHANGELOG.md"
        - "!**/CODE_OF_CONDUCT.md"
        - "!**/.gitignore"
        - "!**/.gitlab-ci.yml"
        - "!**/LICENSE"
        - "!**/.pre-commit-config.yaml"
        - "!**/README.md"
        - "!**/.yamllint"

######################################################
# RUN MOLECULE FOR EACH DISTRIB
######################################################
molecule_debian12:
  stage: molecule
  image: lotusnoir/molecule_play:latest
  extends: .molecule_rules
  script:
    - MOLECULE_DISTRIB=debian12 molecule test
molecule_debian11:
  stage: molecule
  image: lotusnoir/molecule_play:latest
  extends: .molecule_rules
  script:
    - MOLECULE_DISTRIB=debian11 molecule test
molecule_debian10:
  stage: molecule
  image: lotusnoir/molecule_play:v2.0.0
  extends: .molecule_rules
  script:
    - MOLECULE_DISTRIB=debian10 molecule test
molecule_oraclelinux8:
  stage: molecule
  image: lotusnoir/molecule_play:v2.0.0
  extends: .molecule_rules
  script:
    - MOLECULE_DISTRIB=oraclelinux8 molecule test
molecule_oraclelinux9:
  stage: molecule
  image: lotusnoir/molecule_play:latest
  extends: .molecule_rules
  script:
    - MOLECULE_DISTRIB=oraclelinux9 molecule test
molecule_redhat8:
  stage: molecule
  image: lotusnoir/molecule_play:v2.0.0
  extends: .molecule_rules
  script:
    - MOLECULE_DISTRIB=redhat8 molecule test
molecule_redhat9:
  stage: molecule
  image: lotusnoir/molecule_play:latest
  extends: .molecule_rules
  script:
    - MOLECULE_DISTRIB=redhat9 molecule test
molecule_rocky8:
  stage: molecule
  image: lotusnoir/molecule_play:v2.0.0
  extends: .molecule_rules
  script:
    - MOLECULE_DISTRIB=rocky8 molecule test
molecule_rocky9:
  stage: molecule
  image: lotusnoir/molecule_play:latest
  extends: .molecule_rules
  script:
    - MOLECULE_DISTRIB=rocky9 molecule test
molecule_ubuntu20:
  stage: molecule
  image: lotusnoir/molecule_play:latest
  variables:
    MOLECULE_DOCKER_COMMAND: "--cap-add NET_ADMIN"
  extends: .molecule_rules
  script:
    - MOLECULE_DISTRIB=ubuntu20 molecule test
molecule_ubuntu22:
  stage: molecule
  image: lotusnoir/molecule_play:latest
  extends: .molecule_rules
  script:
    - MOLECULE_DISTRIB=ubuntu22 molecule test
molecule_ubuntu24:
  stage: molecule
  image: lotusnoir/molecule_play:latest
  extends: .molecule_rules
  script:
    - MOLECULE_DISTRIB=ubuntu24 molecule test

######################################################
# GENERATE CHANGELOG FILE
######################################################
changelog:
  stage: changes
  image: node:19
  needs:
    - job: molecule_debian12
      optional: true
    - job: molecule_debian11
      optional: true
    - job: molecule_debian10
      optional: true
    - job: molecule_oraclelinux8
      optional: true
    - job: molecule_oraclelinux9
      optional: true
    - job: molecule_redhat8
      optional: true
    - job: molecule_redhat9
      optional: true
    - job: molecule_rocky8
      optional: true
    - job: molecule_rocky9
      optional: true
    - job: molecule_ubuntu20
      optional: true
    - job: molecule_ubuntu22
      optional: true
    - job: molecule_ubuntu24
      optional: true
  artifacts:
    paths:
      - CHANGELOG.md
    expire_in: 1 day
  before_script:
    - apt-get update -qq && apt-get install -y git rsync
    - npm install -g auto-changelog
    - git config --global user.name "CI Bot"
    - git config --global user.email "ci@${CI_SERVER_HOST}"

  script:
    # 1ï¸âƒ£ Clone GitHub repository (source of truth)
    - mkdir -p ~/.ssh
    - echo "$GITHUB_USER_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - echo -e "Host github.com\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
    - eval $(ssh-agent -s)
    - ssh-add ~/.ssh/id_ed25519
    - git clone git@github.com:${GITHUB_USER}/ansible-apps_consul_exporter.git tmp_repo
    - cd tmp_repo
    - git fetch --tags

    # 2ï¸âƒ£ Merge local GitLab changes as working tree diff (no commits)
    - rsync -av --exclude .git "${CI_PROJECT_DIR}/" ./

    # 3ï¸âƒ£ Skip changelog if last commit is already a changelog
    - LAST_MSG="$(git log -1 --pretty=%B || echo '')"
    - |
      if echo "$LAST_MSG" | grep -qiE "changelog|update changelog|maj changelog"; then
        echo "âš ï¸ Last commit is a changelog, skipping."
        echo "skip" > CHANGELOG.md
        exit 0
      fi

    # 4ï¸âƒ£ Debug: show last tags
    - echo "ðŸ”– Tags present on GitHub branch:"
    - git tag --sort=creatordate | tail -n 10

    # 5ï¸âƒ£ Generate changelog based only on GitHub history
    - auto-changelog \
        -t keepachangelog \
        --commit-url "https://github.com/${GITHUB_USER}/ansible-apps_consul_exporter/commit/{{hash}}" \
        --issue-url "" \
        --sort-commits date-desc \
        --hide-empty-releases \
        --hide-credit \
        -b 50

    # 6ï¸âƒ£ Copy changelog to CI project root
    - cp CHANGELOG.md ${CI_PROJECT_DIR}/

##################################################
# PUSH CODE WHEN ALL TEST OK
##################################################
push_src_on_github:
  stage: push
  image: alpine:latest
  needs:
    - changelog
  before_script:
    - apk add git openssh-client
    - eval $(ssh-agent -s)
    - echo "${GITHUB_USER_PRIVATE_KEY}" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo -e "Host *\n\tUser ansible\n\tStrictHostKeyChecking no\n\tForwardAgent yes\n\n" > ~/.ssh/config
    - git config --global user.email "${GITHUB_USER_EMAIL}"
    - git config --global user.name "${GITHUB_USER}"
    - git config --global init.defaultBranch main
    - COMMENT=$(git log -1 --pretty=%B | head -1)
  script:
    - git clone git@github.com:${GITHUB_USER}/ansible-apps_consul_exporter.git /tmp/ansible-apps_consul_exporter
    - find /tmp/ansible-apps_consul_exporter -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf "{}" +;
    - rm -rf .git
    - cp -r . /tmp/ansible-apps_consul_exporter/
    - cd /tmp/ansible-apps_consul_exporter
    - git add -A
    - git commit -m "${COMMENT}" || echo "No changes, nothing to commit!"
    - git push --follow-tags
